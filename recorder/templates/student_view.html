{% extends "base.html" %}

{% block content %}

    <div>
        <!-- student details and actions -->
        <p>Hello, {{ student.first_name }}!</p>
        <p>Student Number: {{ student.user_number }}</p>
        <a href="{{ url_for('logout') }}">Logout</a>
        <hr>
        <!-- end student details and actions -->

        <!-- subscribe to unit modal -->
        <!-- button to open the modal -->
        <button id="btn-subscribe-to-unit" type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-subscribe-to-unit">
            Subscribe to a Unit
        </button>
        <!-- code for modal window -->
        <div class="modal" id="modal-subscribe-to-unit">
            <div class="modal-dialog">
                <div class="modal-content">
                    <!-- modal header -->
                    <div class="modal-header">
                    <h4 class="modal-title">Subscribe to a Unit</h4>
                    <button  id="btn-top-close-subscribe-to-unit-modal" type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <!-- modal body -->
                    <div class="modal-body">
                        <form class="form" action="" method="post" novalidate>
                            {{ form_subscribe_unit.hidden_tag() }}
                            <p>
                                {{ form_subscribe_unit.subscribe_units.label }}<br>
                                {{ form_subscribe_unit.subscribe_units }}<br>
                                {% for error in form_subscribe_unit.subscribe_units.errors %}
                                    <span style="color: red;">[{{ error }}]</span>
                                {% endfor %}
                            </p>
                            <a>{{ form_subscribe_unit.subscribe_unit_submit }}</a>
                        </form>
                    </div>
                    <!-- modal footer -->
                    <div class="modal-footer">
                    <button id="btn-btm-close-subscribe-to-unit-modal" type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- end subscribe to unit modal -->
    </div>
    <hr>

    <!-- list of units, tasks and questions as a Bootstrap4 accordion -->
    <div id="accordion_units">
        <!-- list of units -->
        {% for sUnit in student.units %}
            <div class="card">
                <div class="card-header" id="heading_unit_{{ sUnit.id }}">
                    <h5 class="mb-0">
                        <button class="btn btn-link" data-toggle="collapse" data-target="#collapse_unit_{{ sUnit.id }}" aria-expanded="true" aria-controls="collapse_unit_{{ sUnit.id }}">
                            Unit: {{ sUnit.unit_name }}
                        </button>
                    </h5>
                </div>
                <div id="collapse_unit_{{ sUnit.id }}" class="collapse" aria-labelledby="heading_unit_{{ sUnit.id }}" data-parent="#accordion_units">
                    <div class="card-body" style="background-color: #ecd29d;">
                        <div id="accordion_tasks">
                            <!-- list of tasks for each unit -->
                            {% for task in sUnit.tasks %}
                                <div class="card">
                                    <div class="card-header" id="heading_task_{{ task.id }}">
                                        <h5 class="mb-0">
                                            <button class="btn btn-link" data-toggle="collapse" data-target="#collapse_task_{{ task.id }}" aria-expanded="true" aria-controls="collapse_task_{{ task.id }}">
                                                Task: {{ task.task_name }}
                                            </button>
                                        </h5>
                                    </div>
                                    <div id="collapse_task_{{ task.id }}" class="collapse" aria-labelledby="heading_task_{{ task.id }}" data-parent="#accordion_tasks">
                                        <div class="card-body" style="background-color: #aecee4;">
                                            <div id="accordion_questions">
                                                <!-- list of questions for each task -->
                                                {% for question in task.questions %}
                                                    <div class="card">
                                                        <div class="card-header" id="heading_question_{{ question.id }}">
                                                            <h5 class="mb-0">
                                                                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse_question_{{ question.id }}" aria-expanded="true" aria-controls="collapse_question_{{ question.id }}">
                                                                    Question: {{ question.question_name }}
                                                                </button>
                                                            </h5>
                                                        </div>
                                                        <div id="collapse_question_{{ question.id }}" class="collapse" aria-labelledby="heading_question_{{ question.id }}" data-parent="#accordion_questions">
                                                            <div class="card-body" style="background-color: #d7f8d7;">
                                                                {{ question.description }}
                                                                <!-- recording module -->
                                                                <!-- end recording module -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <hr>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    <!-- end list of units, tasks and questions -->

<!-- recorder    -->

<!--加载核心库，其他类型支持库在下面根据用户点击选择加载-->
<script src="../static/js/recorder-core.js"></script>

<!--加载可选扩展库-->
<script src="../static/js/waveview.js"></script>


<style>
body{
	word-wrap: break-word;
	background:#fff;
}
pre{
	white-space:pre-wrap;
}
.pd{
	padding:0 0 6px 0;
}
.btns button{
	padding: 5px 10px;
}
</style>

<!-- 以下必须要 -->
<script>
//兼容环境
var PageLM="2019-7-17 20:21:42";

function BuildHtml(html,o,notEncode,loop){return o||(o={}),html=(null==html?"":html+"").replace(/\{(fn:)?(:)?(.+?)\}/gi,function(a,b,c,code){try{var v=eval(b?code:"o."+code);return v=void 0===v?"":v+"",c||notEncode?v:v}catch(e){return console.log("BuildHtml Fail",a+"\n"+e.stack),""}}),loop&&/\{(fn:)?(.+?)\}/.test(html)&&(html=BuildHtml(html,o,notEncode,loop)),html};
function RandomKey(){
	return "randomkey"+(RandomKey.idx++);
};
RandomKey.idx=0;
</script>
<script src="https://cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
<!-- 以上必须要 -->

<!-- <div class="demoHead">
	<style>
		.navItem{
			display:inline-block;
			width:40%;
			max-width:300px;
			margin-right:20px;
			vertical-align: top;
			background:#eee;
			border-bottom: 5px solid #ccc;
			color:#666;
			text-decoration:none;
			border-radius: 8px;
			padding: 0 5px 3px;
		}
		.navItem.slc{
			border-bottom: 5px solid #0B1;
			color:#000;
		}
		.navItem:hover{
			color:#d44;
		}
		.navTitle{
			text-align: center;
			font-size:18px;
			font-weight: bold;
		}
		.navDesc{
			font-size:12px;
		}
	</style> -->
	<!-- <a class="navItem slc" href="https://xiangyuecn.github.io/Recorder/">
		<div class="navTitle">Recorder测试</div>
		<div class="navDesc">Recorder库使用简单，功能丰富，支持PC、Android，但IOS上仅Safari支持录音</div>
	</a>
	
	<a class="navItem" href="https://jiebian.life/web/h5/github/recordapp.aspx">
		<div class="navTitle">RecordApp测试</div>
		<div class="navDesc">RecordApp除Recorder支持的外，支持Hybrid App，IOS上支持微信网页和小程序web-view</div>
	</a>
</div> -->

<!-- begin 开始copy源码 -->
<div class="demoMain">
	<!-- <div class="pd gitUrl">
		GitHub：<a href="https://github.com/xiangyuecn/Recorder">https://github.com/xiangyuecn/Recorder</a>
	</div> -->
	<div style="display: none;" class="pd types">
		Audio Type:
		<label><input type="radio" name="type" value="mp3" engine="mp3,mp3-engine" class="initType" checked>mp3</label>

	</div>
	<!-- <div class="pd">
		提示：<span class="typeTips">-</span>
	</div> -->
	<div style="display: none;" class="pd">
		Bit rate: <input type="radio" class="bit" value="64"  checked> 64 kbps
	</div>
	<div style="display: none;" class="pd">
		Sampling rate: <input type="radio" class="sample" value="16000" checked> 16000 hz
	</div>
	<div class="pd btns">
		<button onclick="recopen()">Open Recorder</button>
		<!-- <button onclick="recclose()">关闭录音</button> -->
	</div>
	<div class="pd btns">
		<button onclick="recstart();startTime()">Start</button>
		<button onclick="recstop(); stopTime()">Finish</button>

		
		<!-- <button onclick="recpause();stopTime()" style="margin-left:60px">Pause</button>
		<button onclick="recresume()">Continue</button> -->
	</div>
	<!-- <div class="pd">
		<button onclick="recstop2()">批量编码</button>
		<input type="text" class="bits" value="8 to 96 step 8">kbps 测试音质用的，除比特率外其他参数可调整
	</div> -->
	<div class="pd waveBox">
		<div style="height:100px;width:300px;border:1px solid #ccc;box-sizing: border-box;display:inline-block" class="recwave"></div>
		<input type="checkbox" class="recwaveSet" checked>
	</div>
	<button id="submitted" onclick="submit();change()" style="background-color:lightblue;width:300px; height:80px; font-size:50px;" >Submit!</button>
	<script>
		function submit(){
			alert("Your recording is successfully submitted!");
		}
		function change(){yi1
			document.getElementById("submitted").innerHTML="Submitted!";
		}
	</script>
	<div>Timer
		<p id="showTime">00 : 00</p></div>
	<hr>

	<script>
		var ms = 0;
		var secs = 0;
		var mins = 0;
		var hours = 0;
		var timeoutId;
	
	var isCounting = false;    
	
	function startTime()
	{    
		resetTime()
		if(!isCounting)
		{
			isCounting = true;
			timeoutId = setInterval(countTime,1);        //指定时间执行任务
		}
	
		//document.getElementById("start").value = "计时中";
	}
	
	function stopTime()
	{
		if(isCounting)
		{
			isCounting = false;
			clearTimeout(timeoutId); //清除指定id计时器
			//document.getElementById("start").value = "继续";
		}
	}
	
	function countTime(){
	
		ms+=4;
		if(ms>=1000){
			secs+=1;
			ms = 0;
		}
		if(secs>=60){
		mins+=1;    
		secs = 0;
		}
		if(mins>=60){
		hours+=1;
		mins = 0;    
		}		
		document.getElementById("showTime").innerHTML = checkTime(mins) + " : " + checkTime(secs);
	}

	function checkTime(time)
	{
		if(time<10)
			time = "0"+time;
		
		return time;
	}
	function resetTime()
	{
		ms = 0;
		secs = 0;
		mins = 0;
		hours = 0;        
		
	}
	function clearTime()
	{
		resetTime();
		document.getElementById("showTime").innerHTML = checkTime(mins) + " : " + checkTime(secs);
		if(!isCounting)
			document.getElementById("start").value = "开始计时";
	}
	</script>

	<audio class="recPlay" style="width:100%"></audio>
	<div class="reclog"></div>
</pre>

<!-- 以下很重要 -->

<script>
function reclog(s){
	$(".reclog").prepend('<div>['+new Date().toLocaleTimeString()+']'+s+'</div>');
};
$(window).bind("error",function(e){
	reclog('<span style="color:red">【Error】:<pre>'+(e.error?e.error.stack:event.message)+'</pre></span>');
});
</script>

<script>
var rec;
function recopen(){
	var type=$("[name=type]:checked").val();
	var bit=+$(".bit").val();
	var sample=+$(".sample").val();
	var wave,waveSet=$(".recwaveSet")[0].checked;
	rec=Recorder({
		type:type
		,bitRate:bit
		,sampleRate:sample
		,onProcess:function(buffers,level,time,sampleRate){
			$(".recpowerx").css("width",level+"%");
			$(".recpowert").html(time+"/"+level);
			
			waveSet && wave.input(buffers[buffers.length-1],level,sampleRate);
		}
	});
	
	dialogInt=setTimeout(function(){//定时8秒后打开弹窗，用于监测浏览器没有发起权限请求的情况，在open前放置定时器利于收到了回调能及时取消（不管open是同步还是异步回调的）
		showDialog();
	},8000);
	
	rec.open(function(){
		dialogCancel();
		reclog("setting:"+type+" "+bit+"kbps");
		
		wave=Recorder.WaveView({elem:".recwave"});
	},function(e,isUserNotAllow){
		dialogCancel();
		reclog((isUserNotAllow?"UserNotAllow，":"")+"Fail to open："+e);
	});
	
	window.waitDialogClick=function(){
		dialogCancel();
		reclog("Fail to open：ignore authorism，<span style='color:#f00'>user click allow</span>");
	};
};

//我们可以选择性的弹一个对话框：为了防止移动端浏览器存在第三种情况：用户忽略，并且（或者国产系统UC系）浏览器没有任何回调
var showDialog=function(){
	if(!/mobile/i.test(navigator.userAgent)){
		return;//只在移动端开启没有权限请求的检测
	};
	dialogCancel();
	$("body").append(''
		+'<div class="waitDialog" style="z-index:99999;width:100%;height:100%;top:0;left:0;position:fixed;background:rgba(0,0,0,0.3);">'
			+'<div style="display:flex;height:100%;align-items:center;">'
				+'<div style="flex:1;"></div>'
				+'<div style="width:240px;background:#fff;padding:15px 20px;border-radius: 10px;">'
					+'<div style="padding-bottom:10px;">Please click Allow for recorder to work~</div>'
					+'<div style="text-align:center;"><a onclick="waitDialogClick()" style="color:#0B1">忽略</a></div>'
				+'</div>'
				+'<div style="flex:1;"></div>'
			+'</div>'
		+'</div>');
};
var dialogInt;
var dialogCancel=function(){
	clearTimeout(dialogInt);
	$(".waitDialog").remove();
};
//弹框End

function recstart(){
	if(rec){
		rec.start();
		reclog("Recording...");
	};
};
//function recpause(){
//	if(rec){
//		rec.pause();
//		reclog("已暂停");
//	};
//};
//function recresume(){
//	if(rec){
//		rec.resume();
//		reclog("继续录音中...");
//	};
//};

var recblob={};
function recstop(batCall){
	if(rec){
		if(!batCall){
			reclog("Recording"+rec.set.type+"...");
		};
		var t1=Date.now();
		rec.stop(function(blob,time){
			var id=RandomKey(16);
			recblob[id]={blob:blob,set:$.extend({},rec.set),time:time};
			//留着以后用
			//reclog("Recorded:"+intp(rec.set.bitRate,3)+"kbps "+intp(rec.set.sampleRate,5)+"hz cost"+intp(Date.now()-t1,4)+"ms encoding"+intp(blob.size,6)+"b ["+rec.set.type+"]"+intp(time,6)+'ms <button onclick="recdown(\''+id+'\')">download</button> <button onclick="recplay(\''+id+'\')">play</button> <span class="p'+id+'"></span> <span class="d'+id+'"></span>');
			reclog("Recorded:"+' <button onclick="recdown(\''+id+'\')">download</button> <button onclick="recplay(\''+id+'\')">play</button> <span class="p'+id+'"></span> <span class="d'+id+'"></span>');
			batCall&&batCall();
		},function(s){
			reclog("failed："+s);
			batCall&&batCall();
		});
	};
};
var intp=function(s,len){
	s=s==null?"-":s+"";
	if(s.length>=len)return s;
	return ("_______"+s).substr(-len);
};

//*****重要*********
function recstop2(){
	if(!rec||!rec.buffer){
		reclog("");
		return;
	};
	
	var type=$("[name=type]:checked").val();
	var sample=+$(".sample").val();
	var bits=/(\d+)\s+to\s+(\d+)\s+step\s+(\d+)\s*/i.exec($(".bits").val());
	if(!bits){
		reclog("码率列表有误，需要? to ? step ?结构");
		return;
	};
	reclog("please waiting~");
	
	rec.set.type=type;
	rec.set.sampleRate=sample;
	
	var list=[];
	for(var i=+bits[1];i<+bits[2]+1;i+=+bits[3]){
		list.push(i);
	};
	if(rec.set.type=="wav"){
		list=[8,16];
	};
	
	
	var i=-1;
	var bak=rec.set.bitRate;
	var run=function(){
		i++;
		if(i>=list.length){
			rec.set.bitRate=bak;
			reclog("encoding finished");
			return;
		};
		rec.set.bitRate=list[i];
		rec.state=1;
		recstop(run);
	};
	run();
};
function recplay(key){
	var audio=$(".recPlay")[0];
	audio.controls=true;
	if(!(audio.ended || audio.paused)){
		audio.pause();
	};
	
	var o=recblob[key];
	if(o){
		o.play=(o.play||0)+1;
		var logmsg=function(msg){
			$(".p"+key).html('<span style="color:green">'+o.play+'</span> '+new Date().toLocaleTimeString()+" "+msg);
		};
		logmsg("");
		audio.onerror=function(e){
			console.log(arguments)
			logmsg('<span style="color:red">failed to play</span>');
		};
		
		if(o.play2Name){
			audio.src="assets/audio/"+o.play2Name;
			audio.play();
			return;
		};
		var end=function(blob){
			audio.src=(window.URL||webkitURL).createObjectURL(blob);
			audio.play();
		};
		var wav=Recorder[o.set.type+"2wav"];
        if(wav){
            logmsg("正在转码成wav...");
            wav(o.blob,function(blob){
                end(blob);
                logmsg("已转码成wav播放");
            },function(msg){
                logmsg("转码成wav失败："+msg);
            });
        }else{
            end(o.blob);
        };

	};
};
function recplay2(elem,name){
	elem=$(elem);
	var key="recplay2"+elem.html();
	recblob[key]||(recblob[key]={
		play2Name:name
	});
	if(!$(".p"+key).length){
		elem.before('<br>');
		elem.after('<span class="p'+key+'"></span><br>');
	};
	
	recplay(key);
};





//  download file and URL
function recdown(key){
	var o=recblob[key];
	if(o){
		var cls=RandomKey(16);
		var name="rec-"+o.time+"ms-"+o.set.bitRate+"kbps-"+o.set.sampleRate+"hz."+o.set.type;
		
		o.down=(o.down||0)+1;
		$(".d"+key).html('<span style="color:red">'+o.down+'</span> <span class="'+cls+'"> Not downloading? Try click this link or copy the text to a new window: <button onclick="recdown64(\''+key+'\',\''+cls+'\')">Generate Base64 text</button></span>');
		
		var downA=document.createElement("A");
		downA.innerHTML="download "+name;
		downA.href=(window.URL||webkitURL).createObjectURL(o.blob);
		downA.download=name;
		$("."+cls).prepend(downA);
		downA.click();
	};
};
function recdown64(key, cls){
	var o=recblob[key];
	
	var reader = new FileReader();
	reader.onloadend = function() {
		var id=RandomKey(16);
		$("."+cls).append('<textarea class="'+id+'"></textarea>');
		$("."+id).val(reader.result);
	};
	reader.readAsDataURL(o.blob);
};
$(".recinfo").html(BuildHtml($(".tp_recinfo").html()));
reclog("click [Open recorder]，this browser <span style='color:"+(Recorder.Support()?"green'>":"red'>not")+"support recording</span>");
//reclog("WaveView Extensions已启用");



</script>

<script>
$(function(){
	var prev;
	$(".types").bind("click",function(e){
		var input=$(e.target);
		if(input[0].nodeName=="LABEL"){
			input=$(input).find("input");
		};
		if(prev!=input[0]){
			prev=input[0];
			loadEngine($(input));
		};
	});
});
function loadEngine(input){
	if(input.length&&input[0].nodeName=="INPUT"){
		var type=input.val();
		var engines=input.attr("engine").split(",");
		var end=function(){
			var enc=Recorder.prototype["enc_"+type];
			var tips=[!enc?"这个编码器无提示信息":type+"编码器"+(enc.stable?"稳定版":"beta版")+"，"+enc.testmsg];
			tips.push('<div style="color:green">');
			tips.push("【使用"+type+"录音需要加载的js文件】：");
			tips.push("src/recorder-core.js, src/engine/");
			tips.push(engines.join(".js, src/engine/"));
			tips.push(".js</div>");
			
			$(".typeTips").html(tips.join(""));
		};
		if(!Recorder.prototype[type]){
			reclog("Loading "+type+" encorder...");
			var i=-1;
			var load=function(){
				i++;
				if(i>=engines.length){
					reclog(type+" encorder is ready");
					end();
					return;
				}
				var elem=document.createElement("script");
				elem.setAttribute("type","text/javascript");
				elem.setAttribute("src","src/engine/"+engines[i]+".js");
				elem.onload=function(){
					load();
				};
				$("head")[0].appendChild(elem);
			};
			load();
		}else{
			end();
		};
	};
};
loadEngine($(".initType"));

//pcm测试页面来的
if(/ispcm=1/.test(location.href)){
	$(".demoHead,.gitUrl,.btns,.recpower,.waveBox").hide();
};
</script>



{% endblock %}